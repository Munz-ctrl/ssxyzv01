<!DOCTYPE html>
<html lang="en">

<head>


  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/styles.css">
  <title>Edit Player</title>
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;700&display=swap" rel="stylesheet">

  <script type="module" src="/js/supabase.js"></script>
  <script type="module" src="/js/main.js"></script>
  <script type="module" src="/js/playerUtils.js"></script>
  <script type="module" src="/js/ssxyz.js"></script>


</head>

<body>



  <div class="edit-popup">
    <div class="profile-id" id="playerID">P-ID: </div>
    <input type="text" id="playerName" class="profile-name z-0" placeholder="Player Name" />

    <div class="feature-row">
      <label class="feature-btn" for="uploadSpecial1">
        <img id="previewSpecial1" src="" alt="+" />
      </label>
      <label class="feature-btn" for="uploadSpecial2">
        <img id="previewSpecial2" src="" alt="+" />
      </label>
    </div>


    <div id="mainAvatarPreviewContainer" class="player-main-avatar"></div>

    <input type="file" id="uploadMain" accept="image/*" style="display:none" />



    <textarea id="playerMission" class="mission-textarea" placeholder="Mission(s)... (One per line)"></textarea>

    <!-- <div class="coord-row" style="margin-top: 10px;">
      <label style="font-size: 10px;">Popup BG Color:</label>
      <input type="color" id="popupBgColor" style="width: 40px; height: 30px; border: none;" />
    </div> -->

    <div class="coord-row" style="margin-top: 6px;">
      <label style="font-size: 10px;">Upload BG Image:</label>
      <input type="file" id="popupBgImage" accept="image/*" />
    </div>


    <!-- <button class="save-btn" onclick="savePlayerEdits()">Save Changes</button> -->
    <button class="save-btn" id="saveBtn">Save Changes</button>


    <input type="file" id="uploadSpecial1" accept="image/*" style="display:none" />
    <input type="file" id="uploadSpecial2" accept="image/*" style="display:none" />
    <input type="file" id="uploadAvatar" accept="image/*" style="display:none" />
  </div>

  <button id="logoutBtn" style="
  position: fixed;
  top: 10px;
  right: 10px;
  z-index: 9999;
  padding: 6px 10px;
  background: #222;
  color: white;
  border: none;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
 ">
    Log Out
  </button>

  <button id="backBtn" style="
  position: fixed;
  top: 45px;
  right: 10px;
  z-index: 9999;
  padding: 6px 10px;
  background: #ccc;
  color: black;
  border: none;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
   ">
    ‚Üê Back to Map
  </button>



<script type="module">
import { supabase } from './js/supabase.js';
import { ssxyz } from './js/ssxyz.js';

const params = new URLSearchParams(window.location.search);
const playerId = params.get('id');

let currentAvatarURL = "";
let currentSpecial1URL = "";
let currentSpecial2URL = "";
let currentMainURL = "";
let currentBgImage = "";

let currentUser = null;

(async () => {
  const { data: sessionData } = await supabase.auth.getSession();
  if (!sessionData?.session?.user) await supabase.auth.signInAnonymously();

  const { data } = await supabase.auth.getUser();
  currentUser = data?.user;
  if (!currentUser) {
    alert("‚ùå Failed to retrieve user.");
    return;
  }

  const { data: player, error } = await supabase
    .from('players')
    .select('*')
    .eq('pid', playerId)
    .single();

  if (!player || error) {
    alert("‚ùå Could not load player");
    return;
  }

  ssxyz.activePlayer = player; // ‚úÖ required for uploadImage()

  document.getElementById('playerID').textContent = 'P-ID: ' + player.pid;
  document.getElementById('playerName').value = player.name || '';
  document.getElementById('playerMission').value = (Array.isArray(player.mission) ? player.mission : [player.mission || ""]).join('\n');

  if (player.popupBg?.startsWith('url')) {
    const bgUrl = player.popupBg.match(/url\((.*?)\)/)?.[1]?.replace(/['"]/g, '');
    currentBgImage = bgUrl;
  }

  const editPopup = document.querySelector('.edit-popup');
  editPopup.style.background = player.popupBg?.startsWith('url')
    ? `url(${currentBgImage}) no-repeat center center / cover`
    : player.popupBg || 'rgba(255, 114, 114, 0.4)';

  document.getElementById('popupBgImage').addEventListener('change', async function () {
    const file = this.files[0];
    if (file) {
      const url = await ssxyz.uploadImage(file, 'popupBg.webp');
      if (url) {
        currentBgImage = url;
        editPopup.style.background = `url(${currentBgImage}) no-repeat center center / cover`;
      }
    }
  });

  const avatarContainer = document.getElementById('mainAvatarPreviewContainer');
  const fallback = '/assets/fallbackIsoAvatar.webp';
  avatarContainer.innerHTML = player.spritesheet
    ? `<div class="sprite-anim" style="background-image: url('${player.spritesheet}')"></div>`
    : player.main
    ? `<img src="${player.main}" />`
    : player.avatar
    ? `<img src="${player.avatar}" />`
    : `<img src="${fallback}" class="fallback" />`;

  if (player.special) document.getElementById('previewSpecial1').src = currentSpecial1URL = player.special;
  if (player.special2) document.getElementById('previewSpecial2').src = currentSpecial2URL = player.special2;

  document.getElementById('saveBtn')?.addEventListener('click', savePlayerEdits);
})();

document.getElementById('uploadMain').addEventListener('change', async function () {
  const file = this.files[0];
  if (file) {
    const url = await ssxyz.uploadImage(file, 'main.webp');
    if (url) {
      currentMainURL = url;
      document.getElementById('mainPreview')?.src = url;
    }
  }
});

document.getElementById('uploadSpecial1').addEventListener('change', async function () {
  const file = this.files[0];
  if (file) {
    const url = await ssxyz.uploadImage(file, 'special1.webp');
    if (url) {
      currentSpecial1URL = url;
      document.getElementById('previewSpecial1').src = url;
    }
  }
});

document.getElementById('uploadSpecial2').addEventListener('change', async function () {
  const file = this.files[0];
  if (file) {
    const url = await ssxyz.uploadImage(file, 'special2.webp');
    if (url) {
      currentSpecial2URL = url;
      document.getElementById('previewSpecial2').src = url;
    }
  }
});

document.getElementById('uploadAvatar').addEventListener('change', async function () {
  const file = this.files[0];
  if (file) {
    const url = await ssxyz.uploadImage(file, 'avatar.webp');
    if (url) {
      currentAvatarURL = url;
      document.getElementById('avatarPreview')?.src = url;
    }
  }
});

async function savePlayerEdits() {
  const { data: userData, error: userError } = await supabase.auth.getUser();
  if (userError || !userData?.user?.id) {
    alert("‚ùå You're not logged in.");
    return;
  }

  const name = document.getElementById('playerName').value.trim();
  const mission = document.getElementById('playerMission').value.trim().split('\n');
  let popupBg = currentBgImage ? `url(${currentBgImage})` : 'rgba(255, 114, 114, 0.4)';

  const updates = {
    name: name || '',
    mission: mission.filter(Boolean),
    main: currentMainURL || '',
    popupBg: popupBg
  };

  const { error } = await supabase.from('players').update(updates).eq('pid', playerId);
  if (error) {
    console.error("‚ùå Failed to save edits:", error);
    alert('‚ùå Edit failed. You may not be the owner of this player.');
  } else {
    alert('‚úÖ Player updated!');
    localStorage.setItem('playerPid', playerId);
    location.href = 'index.html';
  }
}

document.getElementById('logoutBtn')?.addEventListener('click', async () => {
  localStorage.removeItem('playerPid');
  localStorage.removeItem('playerPin');
  await supabase.auth.signOut();
  alert('üëã Logged out.');
  location.href = 'index.html';
});

document.getElementById('backBtn')?.addEventListener('click', () => {
  location.href = 'index.html';
});
</script>





  <!-- <button id="upgradeEmailBtn">üîê Secure My Account</button> -->

</body>

</html>